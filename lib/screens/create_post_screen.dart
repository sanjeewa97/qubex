import 'package:flutter/material.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'dart:io';
import 'package:image_picker/image_picker.dart';
import '../theme/app_theme.dart';
import '../models/post_model.dart';
import '../services/firebase_service.dart';
import '../services/auth_service.dart';

import '../widgets/loading_widget.dart';

class CreatePostScreen extends StatefulWidget {
  final PostModel? postToEdit;
  const CreatePostScreen({super.key, this.postToEdit});

  @override
  State<CreatePostScreen> createState() => _CreatePostScreenState();
}

class _CreatePostScreenState extends State<CreatePostScreen> {
  final _contentController = TextEditingController();
  final List<TextEditingController> _optionControllers = [];
  final FirebaseService _firebaseService = FirebaseService();
  final AuthService _authService = AuthService();
  
  String _selectedType = 'Question'; // Question, Achievement, Poll, Quiz
  bool _isLoading = false;
  int? _correctOptionIndex; // For Quiz
  File? _selectedImage;
  final ImagePicker _picker = ImagePicker();
  
  // For Edit Mode
  bool get _isEditing => widget.postToEdit != null;
  String? _networkImageUrl;

  @override
  void initState() {
    super.initState();
    if (_isEditing) {
      final post = widget.postToEdit!;
      _contentController.text = post.content;
      _selectedType = post.type;
      _networkImageUrl = post.imageUrl;
      
      // Load options if any
      if (post.pollOptions.isNotEmpty) {
        for (var option in post.pollOptions) {
          _optionControllers.add(TextEditingController(text: option));
        }
      } else {
        // Default options if switching types (though we likely lock type)
        _addOption();
        _addOption();
      }
      _correctOptionIndex = post.correctOptionIndex;
    } else {
       _addOption(); // Start with 2 options
       _addOption();
    }
  }

  void _addOption() {
    if (_optionControllers.length < 4) {
      setState(() {
        _optionControllers.add(TextEditingController());
      });
    }
  }

  void _removeOption(int index) {
    if (_optionControllers.length > 2) {
      setState(() {
        _optionControllers.removeAt(index);
        if (_correctOptionIndex == index) _correctOptionIndex = null;
        if (_correctOptionIndex != null && _correctOptionIndex! > index) {
          _correctOptionIndex = _correctOptionIndex! - 1;
        }
      });
    }
  }

  Future<void> _pickImage() async {
    final XFile? image = await _picker.pickImage(source: ImageSource.gallery);
    if (image != null) {
      setState(() {
        _selectedImage = File(image.path);
        _networkImageUrl = null; // Override network image if new one picked
      });
    }
  }

  Future<void> _handlePostSubmission() async {
    if (_contentController.text.trim().isEmpty) return;

    setState(() => _isLoading = true);
    
    try {
      print("DEBUG: _handlePostSubmission start. isEditing: $_isEditing");
      if (_isEditing) {
        // Update Logic
        print("DEBUG: Updating post ${widget.postToEdit!.id} with content: ${_contentController.text}");
        // For MVP, we only allow updating TEXT content.
        // If we want to support logic changes (polls/images) it gets complex.
        // Let's assume we just update Content for now as per plan.
        await _firebaseService.updatePost(widget.postToEdit!.id, _contentController.text.trim());
      } else {
        // Create Logic follows...
        await _performCreate();
      }

      if (mounted) {
        Navigator.pop(context);
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text("Error: $e")),
        );
      }
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  Future<void> _performCreate() async {
    // Validation for Poll/Quiz
    if (_selectedType == 'Poll' || _selectedType == 'Quiz') {
      if (_optionControllers.any((c) => c.text.trim().isEmpty)) {
        ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Please fill all options")));
        return;
      }
      if (_selectedType == 'Quiz' && _correctOptionIndex == null) {
        ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Please select a correct answer for the quiz")));
        return;
      }
    }

      final user = _authService.currentUser;
      if (user == null) throw "User not logged in";

      // Fetch latest user data from Firestore
      final userModel = await _firebaseService.getUser(user.uid);

      // Upload Image if selected
      String? imageUrl;
      if (_selectedImage != null) {
         imageUrl = await _firebaseService.uploadPostImage(_selectedImage!);
      }

      // Create Post Model
      final post = PostModel(
        id: '', // Generated by Firestore
        authorId: user.uid,
        authorName: userModel?.name ?? user.displayName ?? 'Anonymous',
        authorPhotoUrl: userModel?.photoUrl.isNotEmpty == true ? userModel!.photoUrl : user.photoURL ?? '',
        school: userModel?.school ?? 'Unknown School',
        grade: userModel?.grade ?? '',
        content: _contentController.text.trim(),
        type: _selectedType,
        timestamp: DateTime.now(),
        likes: 0,
        comments: 0,
        isAchievement: _selectedType == 'Achievement',
        pollOptions: (_selectedType == 'Poll' || _selectedType == 'Quiz') 
            ? _optionControllers.map((c) => c.text.trim()).toList() 
            : [],
        correctOptionIndex: _selectedType == 'Quiz' ? _correctOptionIndex : null,
        imageUrl: imageUrl, 
      );

      await _firebaseService.createPost(post);
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(
        backgroundColor: Colors.white,
        elevation: 0,
        leading: IconButton(
          icon: const Icon(Icons.close, color: Colors.black),
          onPressed: () => Navigator.pop(context),
        ),
        title: Text(_isEditing ? "Edit Post" : "Create Post", style: const TextStyle(color: Colors.black, fontWeight: FontWeight.bold)),
        centerTitle: true,
        actions: [
          Padding(
            padding: const EdgeInsets.only(right: 16.0),
            child: TextButton(
              onPressed: _isLoading ? null : _handlePostSubmission,
              style: TextButton.styleFrom(
                backgroundColor: AppTheme.primary,
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
                padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 8),
              ),
              child: _isLoading 
                ? const LoadingWidget(size: 20, color: Colors.white)
                : Text(_isEditing ? "Update" : "Post", style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
            ),
          )
        ],
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(20.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // User Header
            Row(
              children: [
                CircleAvatar(
                  radius: 20,
                  backgroundColor: AppTheme.secondary,
                  backgroundImage: _authService.currentUser?.photoURL != null ? NetworkImage(_authService.currentUser!.photoURL!) : null,
                  child: _authService.currentUser?.photoURL == null ? const Icon(Icons.person, color: Colors.white) : null,
                ),
                const SizedBox(width: 12),
                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      _authService.currentUser?.displayName ?? _authService.currentUser?.email?.split('@')[0] ?? "User",
                      style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 16),
                    ),
                    Text(
                      "Public â€¢ ${_authService.currentUser?.email != null ? "Grade 13" : ""}", 
                      style: TextStyle(color: Colors.grey.shade600, fontSize: 12),
                    ),
                  ],
                )
              ],
            ),
            
            const SizedBox(height: 20),

            // Type Selector (Chips) - Disabled if Editing
            if (!_isEditing)
            SingleChildScrollView(
              scrollDirection: Axis.horizontal,
              child: Row(
                children: ['Question', 'Achievement', 'Poll', 'Quiz'].map((type) {
                  final isSelected = _selectedType == type;
                  return Padding(
                    padding: const EdgeInsets.only(right: 8.0),
                    child: ChoiceChip(
                      label: Text(type),
                      selected: isSelected,
                      onSelected: (selected) {
                        if (selected) setState(() => _selectedType = type);
                      },
                      selectedColor: AppTheme.primary,
                      backgroundColor: Colors.grey.shade100,
                      labelStyle: TextStyle(
                        color: isSelected ? Colors.white : Colors.black,
                        fontWeight: FontWeight.bold,
                      ),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(20),
                        side: BorderSide(color: isSelected ? AppTheme.primary : Colors.transparent),
                      ),
                    ),
                  );
                }).toList(),
              ),
            ),

            const SizedBox(height: 20),

            // Content Input
            TextField(
              controller: _contentController,
              maxLines: null,
              minLines: 4,
              decoration: InputDecoration(
                hintText: _selectedType == 'Quiz' 
                    ? "Ask your quiz question here..." 
                    : _selectedType == 'Poll' 
                        ? "Ask your poll question..." 
                        : "What's on your mind?",
                border: InputBorder.none,
                hintStyle: TextStyle(fontSize: 20, color: Colors.grey.shade400),
              ),
              style: const TextStyle(fontSize: 20),
            ),
            
            // Image Preview (Handle both file and network)
            if (_selectedImage != null || _networkImageUrl != null)
              Stack(
                children: [
                  Container(
                    margin: const EdgeInsets.only(top: 16),
                    height: 200,
                    width: double.infinity,
                    decoration: BoxDecoration(
                      borderRadius: BorderRadius.circular(16),
                      image: DecorationImage(
                        image: _selectedImage != null 
                          ? FileImage(_selectedImage!) 
                          : NetworkImage(_networkImageUrl!) as ImageProvider,
                        fit: BoxFit.cover
                      ),
                    ),
                  ),
                  if (!_isEditing) // Don't allow removing image in Edit mode for simplicity
                  Positioned(
                    top: 24,
                    right: 8,
                    child: GestureDetector(
                      onTap: () => setState(() => _selectedImage = null),
                      child: Container(
                        padding: const EdgeInsets.all(4),
                        decoration: const BoxDecoration(color: Colors.black54, shape: BoxShape.circle),
                        child: const Icon(Icons.close, color: Colors.white, size: 20),
                      ),
                    ),
                  ),
                ],
              ),
              
            // Add Photo Button - Disabled in Edit Mode
            if (_selectedImage == null && _networkImageUrl == null && !_isEditing)
              Padding(
                padding: const EdgeInsets.only(top: 16.0),
                child: TextButton.icon(
                  onPressed: _pickImage,
                  icon: const Icon(Icons.add_photo_alternate_outlined, color: AppTheme.primary),
                  label: const Text("Add Photo", style: TextStyle(color: AppTheme.primary)),
                  style: TextButton.styleFrom(
                    padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
                    backgroundColor: AppTheme.primary.withValues(alpha: 0.1),
                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12))
                  ),
                ),
              ),

            // Poll / Quiz Options Section - Disabled in Edit Mode (Hidden)
            if (!_isEditing && (_selectedType == 'Poll' || _selectedType == 'Quiz')) ...[
              const SizedBox(height: 20),
              Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: Colors.grey.shade50,
                  borderRadius: BorderRadius.circular(16),
                  border: Border.all(color: Colors.grey.shade200),
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        Text(
                          _selectedType == 'Quiz' ? "QUIZ OPTIONS" : "POLL OPTIONS",
                          style: TextStyle(
                            color: Colors.grey.shade600,
                            fontWeight: FontWeight.bold,
                            fontSize: 12,
                            letterSpacing: 1.2,
                          ),
                        ),
                        if (_selectedType == 'Quiz')
                          const Text(
                            "(Tap circle for correct answer)",
                            style: TextStyle(color: Colors.green, fontSize: 10, fontStyle: FontStyle.italic),
                          ),
                      ],
                    ),
                    const SizedBox(height: 16),
                    
                    ...List.generate(_optionControllers.length, (index) {
                      final isCorrect = _correctOptionIndex == index;
                      return Container(
                        margin: const EdgeInsets.only(bottom: 12),
                        decoration: BoxDecoration(
                          color: Colors.white,
                          borderRadius: BorderRadius.circular(12),
                          border: Border.all(
                            color: (_selectedType == 'Quiz' && isCorrect) 
                                ? Colors.green 
                                : Colors.grey.shade300,
                            width: (_selectedType == 'Quiz' && isCorrect) ? 2 : 1,
                          ),
                          boxShadow: [
                            BoxShadow(color: Colors.black.withValues(alpha: 0.03), blurRadius: 4, offset: const Offset(0, 2))
                          ],
                        ),
                        child: Row(
                          children: [
                            if (_selectedType == 'Quiz')
                              GestureDetector(
                                onTap: () => setState(() => _correctOptionIndex = index),
                                child: Padding(
                                  padding: const EdgeInsets.all(12.0),
                                  child: Icon(
                                    isCorrect ? Icons.check_circle : Icons.radio_button_unchecked,
                                    color: isCorrect ? Colors.green : Colors.grey,
                                  ),
                                ),
                              )
                            else 
                              const Padding(
                                padding: EdgeInsets.all(12.0),
                                child: Icon(Icons.drag_indicator, color: Colors.grey, size: 20),
                              ),
                              
                            Expanded(
                              child: TextField(
                                controller: _optionControllers[index],
                                decoration: InputDecoration(
                                  hintText: "Option ${index + 1}",
                                  border: InputBorder.none,
                                  contentPadding: const EdgeInsets.symmetric(horizontal: 0, vertical: 12),
                                ),
                              ),
                            ),
                            
                            if (_optionControllers.length > 2)
                              IconButton(
                                icon: const Icon(Icons.close, color: Colors.grey, size: 20),
                                onPressed: () => _removeOption(index),
                              )
                          ],
                        ),
                      );
                    }),
                    
                    if (_optionControllers.length < 4)
                      Center(
                        child: TextButton.icon(
                          onPressed: _addOption,
                          icon: const Icon(Icons.add_circle_outline),
                          label: const Text("Add Option"),
                          style: TextButton.styleFrom(
                            foregroundColor: AppTheme.primary,
                          ),
                        ),
                      ),
                  ],
                ),
              ),
            ]
          ],
        ),
      ),
    );
  }
}
